clear;clfLdata=100000;Lc=31;data_sym=2*round(rand(Ldata,4))-1+j*(2*round(rand(Ldata,4))-1);GPN=[1 1 1 -1	-1 1 -1 1	-1 -1 1 1	1 1 -1 -1	-1 -1 -1 -1	1 1 1 1	1 1 -1 -1	-1 -1 -1 1	-1 1 -1 -1	1 -1 -1 1	-1 -1 1 1	1 1 -1 1	1 -1 -1 -1	-1 1 1 1	1 -1 1 1	-1 1 1 -1	-1 -1 1 -1	-1 1 1 -1	1 1 1 -1	1 -1 1 1	1 -1 1 -1	1 1 -1 -1	1 1 1 1	1 1 -1 -1	-1 -1 -1 -1	1 1 -1 1	1 -1 -1 -1	-1 1 -1 1	1 1 -1 -1	1 1 1 1	1 1 1 1];pcode=GPN;PowerMat=diag(sqrt([10 1 5 1]));pcodew=pcode*PowerMat;Rcor=pcodew'*pcodew;Rinv=pinv(Rcor);x_in=kron(data_sym(:,1),pcodew(:,1))+kron(data_sym(:,2),pcodew(:,2))+kron(data_sym(:,3),pcodew(:,3))+kron(data_sym(:,4),pcodew(:,4));noiseq=randn(Ldata*Lc,1)+j*randn(Ldata*Lc,1);BERa2=[];BERb2=[];BERa4=[];BERb4=[];BER_az=[];for i=1:13,    Eb2N(i)=(i-1);    Eb2N_num=10^(Eb2N(i)/10);    Var_n=Lc/(2*Eb2N_num);    signois=sqrt(Var_n);    awgnois=signois*noiseq;    y_out=x_in+awgnois;    Y_out=reshape(y_out,Lc,Ldata).';    z_out=(Y_out*pcode);    clear Y_out;    	z_dcr=z_out*Rinv;		dec1=sign(real(z_out))+j*sign(imag(z_out));	dec2=sign(real(z_dcr))+j*sign(imag(z_dcr));		BERa2=[BERa2;sum([real(data_sym(:,2))~=real(dec1(:,2));imag(data_sym(:,2))~=imag(dec1(:,2))])/(2*Ldata)];		BERa4=[BERa4;sum([real(data_sym(:,4))~=real(dec1(:,4));imag(data_sym(:,4))~=imag(dec1(:,4))])/(2*Ldata)];		BERb2=[BERb2;sum([real(data_sym(:,2))~=real(dec2(:,2));imag(data_sym(:,2))~=imag(dec2(:,2))])/(2*Ldata)];		BERb4=[BERb4;sum([real(data_sym(:,4))~=real(dec2(:,4));imag(data_sym(:,4))~=imag(dec2(:,4))])/(2*Ldata)];		BER_az=[BER_az;0.5*erfc(sqrt(Eb2N_num))];endfigure(1)figber=semilogy(Eb2N,BER_az,'k-',Eb2N,BERa2,'k-o',Eb2N,BERa4,'k-s',Eb2N,BERb2,'k--o',Eb2N,BERb4,'k--s');legend('Apenas um usuário (análise)','Usuário 2(detecção de usuário único)','Usuário 4(detecção de usuário único)','Usuário 2(descorrelacionados)','Usuário 4(descorrelacionados');axis([0 12 0.99e-5 1.e0]);set(figber,'LineWidth',2);xlabel('E_b/N (dB)');ylabel('Taxa de erro QPSK');title('Comparações de BER de usuários fracos');